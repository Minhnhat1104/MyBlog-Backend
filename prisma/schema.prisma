// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// "npx prisma generate" generate node_modules/.prisma/client
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// Mysql Prisma type mapping: https://www.prisma.io/docs/orm/overview/databases/mysql#type-mapping-between-mysql-to-prisma-schema
// use migration to update: 
// 1) npx prisma migrate dev --name init
// 2) check folder generate prisma/migrations/

// npx prisma migrate dev --name init
// 1) schema.prisma
// 2) So sánh DB
// 3) Sinh migration.sql
// 4) Chạy SQL vào MySQL
// 5) Lưu lịch sử migration ở table "prisma_migrations"
// 6) Generate Prisma Client: npx prisma generate

// npx prisma migrate deploy
// Lấy những migration đã apply vào DB dev để apply vào db thật
// 1) Đọc các migration trong prisma/migrations
// 2) Kiểm tra bảng _prisma_migrations
// 3) Chạy chính xác những migration CHƯA chạy
// 3) KHÔNG tạo migration mới, Không reset DB
// 4) Không chạy Generate Prisma

model User {
  id              Int                   @id @default(autoincrement())
  last_name       String                @default("")
  first_name      String                @default("")
  email           String                @unique
  password        String
  admin           Boolean
  avatar_id       Int?                  @unique
  avatar          Image?                @relation("UserAvatar", fields: [avatar_id], references: [id])
  images          Image[]               @relation("UserImages")
  albums          Album[]
  favorite_images User_Image_Favotire[]
  created_at      DateTime              @default(now())
  updated_at      DateTime              @default(now()) @updatedAt
}

model Tag {
  id         Int      @id @default(autoincrement())
  label      String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  images     Image[]
}

model Album {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  creator_id  Int
  creator     User     @relation(fields: [creator_id], references: [id])
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt
  images      Image[]
}

model User_Image_Favotire {
  id         Int      @id @default(autoincrement())
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id])
  image_id   Int
  image      Image    @relation(fields: [image_id], references: [id])
  created_at DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@unique([user_id, image_id])
}

model Image {
  id             Int                   @id @default(autoincrement())
  name           String
  ext            String
  width          Int
  height         Int
  path           String
  tags           Tag[]
  favorite_users User_Image_Favotire[]
  // album (1–n)
  album_id       Int?
  album_of       Album?                @relation(fields: [album_id], references: [id])
  // avatar (1–1)
  avatar_of      User?                 @relation("UserAvatar")
  // images (1–n)
  creator        User                  @relation("UserImages", fields: [creator_id], references: [id])
  creator_id     Int
  created_at     DateTime              @default(now())
  updated_at     DateTime              @default(now()) @updatedAt
}
